name: E2E Verification

on:
  push:
    branches:
      - main
      - feature/*
  workflow_dispatch:

permissions:
  contents: read

jobs:
  test-go-arm64:
    name: Go (CGO) arm64-linux
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'
          cache: false


      - name: Create Dist Dir
        run: mkdir -p dist

      - name: Build Go (CGO)
        uses: ./ # Uses local action
        with:
          target: linux-arm64
          project-type: go
          cmd: |
             cd examples/go-cgo
             go build -o ../../dist/app-go-arm64 .

      - name: Verify Go Binary
        run: file dist/app-go-arm64 | grep "ARM aarch64"

  test-rust-gnu:
    name: Rust aarch64-gnu
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-unknown-linux-gnu

      - name: Build Rust (Release)
        uses: ./
        with:
          target: aarch64-unknown-linux-gnu
          project-type: rust
          cmd: |
            cd examples/rust-aarch64
            cargo build --release --target aarch64-unknown-linux-gnu

      - name: Verify Rust Binary
        run: file examples/rust-aarch64/target/aarch64-unknown-linux-gnu/release/rust_cross | grep "ARM aarch64"

  test-c-windows:
    name: C windows-x64
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Create Dist Dir
        run: mkdir -p dist

      - name: Build C (Direct CC)
        uses: ./
        with:
          target: windows-x64
          project-type: c
          cmd: $CC examples/c-windows/main.c -o dist/app.exe

      - name: Verify C Binary
        run: file dist/app.exe | grep "PE32+"

  test-c-macos:
    name: C macos-arm64 (on macos-latest)
    runs-on: macos-latest
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Create Dist Dir
        run: mkdir -p dist

      - name: Build C (Direct CC)
        uses: ./
        with:
          target: aarch64-macos
          project-type: c
          cmd: $CC examples/c-macos/main.c -o dist/app-macos

      - name: Verify Mach-O Binary
        run: file dist/app-macos | grep "Mach-O"
  test-c-linux-matrix:
    name: C (${{ matrix.name }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: linux-gnu
            target: x86_64-linux-gnu
            example-dir: c-linux-gnu
          - name: linux-musl
            target: x86_64-linux-musl
            example-dir: c-linux-musl

    steps:
      - uses: actions/checkout@v4

      - name: Build C example (${{ matrix.name }})
        uses: ./
        with:
          target: ${{ matrix.target }}
          project-type: c
          cmd: |
            cd examples/${{ matrix.example-dir }}
            mkdir -p dist
            $CC main.c -o dist/app

      - name: Verify binary type (${{ matrix.name }})
        run: |
          file examples/${{ matrix.example-dir }}/dist/app
          # Basic check: 64-bit ELF
          file examples/${{ matrix.example-dir }}/dist/app | grep "ELF 64-bit LSB" >/dev/null

          # Optional: distinguish glibc vs musl (static)
          if [[ "${{ matrix.target }}" == "x86_64-linux-musl" ]]; then
            echo "Checking for statically linked (musl) binary..."
            file examples/${{ matrix.example-dir }}/dist/app | grep -i "statically linked" >/dev/null
          fi

      - name: Smoke test binary (${{ matrix.name }})
        run: |
          ./examples/${{ matrix.example-dir }}/dist/app
