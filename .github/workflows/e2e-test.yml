name: "Action E2E Test"

on:
  push:
    branches: [main, master, feat/zig-cca-v3]
  pull_request:

jobs:
  test-minimal:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Only (Minimal)
        uses: ./
        with:
          version: "0.13.0"
          setup_only: "true"
          target_preset: "linux-x86_64-musl"

      - name: Verify Setup
        run: |
          zig version
          echo "Target env: $ZIG_TARGET"
          if [[ "$ZIG_TARGET" != "x86_64-linux-musl" ]]; then exit 1; fi

  test-caching:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Prime Cache
        uses: ./
        with:
          version: "0.13.0"
          setup_only: "true"
          use_cache: "true"
          cache_suffix: "test"
          target_preset: "linux-x86_64" # triggers cache key

      - name: Use Cache
        id: cache-check
        uses: ./
        with:
          version: "0.13.0"
          setup_only: "true"
          use_cache: "true"
          cache_suffix: "test"
          target_preset: "linux-x86_64"

      - name: Verify Hit
        if: steps.cache-check.outputs.cache_hit != 'true'
        run: |
           echo "Expected cache hit on second run"
           # Warning only strictly, GitHub cache is eventually consistent
           echo "Cache miss observed - verify in logs"

  test-supply-chain:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Create Dummy Artifact
        run: |
          mkdir -p dist
          echo "dummy-binary" > dist/dummy

      - name: SBOM and Sign
        uses: ./
        with:
          version: "0.13.0"
          setup_only: "true"
          sbom: "true"
          sbom_target: "dist/dummy"
          sbom_output: "dist/dummy.sbom.json"
          sign: "true"
          sign_artifact: "dist/dummy"

      - name: Verify Outputs
        run: |
          ls -l dist/
          if [[ ! -s dist/dummy.sbom.json ]]; then exit 1; fi
          if [[ ! -s dist/dummy.sig ]]; then exit 1; fi
          if [[ ! -s dist/dummy.crt ]]; then exit 1; fi

  test-legacy-compat:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: v2 Compatible Run
        uses: ./
        with:
          version: "0.13.0"
          target: "x86_64-linux-musl"
          project-type: "custom"
          cmd: "echo 'Running Custom Command' && zig version"
